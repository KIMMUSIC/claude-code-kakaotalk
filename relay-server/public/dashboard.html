<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kakao Relay - Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
      color: #333;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    .header h1 { font-size: 1.3rem; }
    .header-actions { display: flex; gap: 1rem; align-items: center; }
    .header-user { font-size: 0.85rem; opacity: 0.9; }
    .btn-logout {
      background: rgba(255,255,255,0.2);
      color: white;
      border: 1px solid rgba(255,255,255,0.3);
      padding: 0.4rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      text-decoration: none;
    }
    .btn-logout:hover { background: rgba(255,255,255,0.3); }
    .main {
      max-width: 800px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: #1a1a2e;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .card h2 .icon { font-size: 1.3rem; }
    .status-badge {
      display: inline-block;
      padding: 0.2rem 0.8rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .status-connected {
      background: #e8f5e9;
      color: #2e7d32;
    }
    .status-disconnected {
      background: #fff3e0;
      color: #ef6c00;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 0.6rem 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.9rem;
    }
    .info-row:last-child { border-bottom: none; }
    .info-label { color: #666; }
    .info-value { font-weight: 500; }
    .btn-action {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 0.6rem 1.5rem;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: transform 0.2s;
      text-decoration: none;
    }
    .btn-action:hover { transform: translateY(-1px); }
    .btn-action:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }
    .btn-secondary:hover { background: #f5f7ff; }
    .code-block {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 1rem;
      border-radius: 8px;
      font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
      font-size: 0.82rem;
      overflow-x: auto;
      line-height: 1.5;
      position: relative;
      white-space: pre;
    }
    .copy-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(255,255,255,0.1);
      color: #d4d4d4;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.75rem;
    }
    .copy-btn:hover { background: rgba(255,255,255,0.2); }
    .loading {
      text-align: center;
      padding: 2rem;
      color: #999;
    }
    .spinner {
      width: 32px; height: 32px;
      border: 3px solid #e0e0e0;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .alert {
      padding: 0.8rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
    }
    .alert-success { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; }
    .alert-error { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    .steps { padding-left: 1.2rem; }
    .steps li {
      padding: 0.4rem 0;
      font-size: 0.9rem;
      color: #444;
      line-height: 1.5;
    }
    .section-divider {
      margin: 1rem 0;
      border: none;
      border-top: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>Kakao Relay Dashboard</h1>
    <div class="header-actions">
      <span id="headerUser" class="header-user"></span>
      <a id="logoutBtn" class="btn-logout" href="/auth/logout">Logout</a>
    </div>
  </div>

  <div class="main">
    <!-- Alert area -->
    <div id="alertArea"></div>

    <!-- Loading -->
    <div id="loadingArea" class="card loading">
      <div class="spinner"></div>
      <p>사용자 정보를 불러오는 중...</p>
    </div>

    <!-- User Info Card -->
    <div id="userCard" class="card" style="display:none">
      <h2><span class="icon">&#128100;</span> 사용자 정보</h2>
      <div class="info-row">
        <span class="info-label">User ID</span>
        <span class="info-value" id="userId">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">인증 방식</span>
        <span class="info-value" id="authMethod">-</span>
      </div>
    </div>

    <!-- Kakao Connect Card -->
    <div id="kakaoCard" class="card" style="display:none">
      <h2><span class="icon">&#128172;</span> 카카오 연동</h2>
      <div id="kakaoStatus"></div>
      <div style="margin-top: 1rem;">
        <button id="kakaoConnectBtn" class="btn-action" onclick="connectKakao()">카카오 연동하기</button>
      </div>
    </div>

    <!-- Local Bridge Setup Card -->
    <div id="bridgeCard" class="card" style="display:none">
      <h2><span class="icon">&#128295;</span> Local Bridge 설정</h2>
      <p style="font-size:0.9rem;color:#666;margin-bottom:1rem;">
        Claude Code에서 카카오 알림을 사용하려면 아래 설정이 필요합니다.
      </p>

      <h3 style="font-size:0.95rem;margin-bottom:0.5rem;">Step 1: 설치</h3>
      <p style="font-size:0.85rem;color:#666;margin-bottom:0.5rem;">
        터미널에서 아래 명령어를 실행하여 local-bridge를 설치합니다.
      </p>
      <div class="code-block" id="installBlock" style="position:relative;"><button class="copy-btn" onclick="copyBlock('installText')">Copy</button><span id="installText">git clone https://github.com/KIMMUSIC/claude-code-kakaotalk.git
cd claude-code-kakaotalk/local-bridge
npm install
npm run build</span></div>

      <hr class="section-divider">

      <h3 style="font-size:0.95rem;margin-bottom:0.5rem;">Step 2: CLI 로그인</h3>
      <p style="font-size:0.85rem;color:#666;margin-bottom:0.5rem;">
        local-bridge 디렉토리에서 로그인 명령을 실행합니다. 브라우저가 열리면 로그인하세요.
      </p>
      <div class="code-block" style="position:relative;"><button class="copy-btn" onclick="copyBlock('loginText')">Copy</button><span id="loginText">node dist/login.js</span></div>

      <hr class="section-divider">

      <h3 style="font-size:0.95rem;margin-bottom:0.5rem;">Step 3: MCP 설정</h3>
      <p style="font-size:0.85rem;color:#666;margin-bottom:0.5rem;">
        Claude Code 프로젝트의 <code>.claude/mcp.json</code> 파일에 아래 내용을 추가합니다.
        <code>&lt;path-to&gt;</code>를 실제 설치 경로로 바꿔주세요.
      </p>
      <div class="code-block" style="position:relative;" id="mcpConfigBlock"><button class="copy-btn" onclick="copyMcpConfig()">Copy</button></div>

      <hr class="section-divider">

      <h3 style="font-size:0.95rem;margin-bottom:0.5rem;">Step 4: 테스트</h3>
      <ol class="steps">
        <li>Claude Code를 재시작합니다.</li>
        <li>Claude에게 "카카오톡으로 사용자에게 확인해줘"라고 요청합니다.</li>
        <li>카카오톡에서 질문을 확인하고 답변합니다.</li>
      </ol>
    </div>
  </div>

  <script>
    // ── Token Management ──────────────────────────────────
    function getToken() {
      return sessionStorage.getItem('id_token') || sessionStorage.getItem('access_token');
    }

    function getRefreshToken() {
      return sessionStorage.getItem('refresh_token');
    }

    function clearTokens() {
      sessionStorage.removeItem('id_token');
      sessionStorage.removeItem('access_token');
      sessionStorage.removeItem('refresh_token');
      sessionStorage.removeItem('expires_at');
    }

    function isTokenExpired() {
      var expiresAt = parseInt(sessionStorage.getItem('expires_at') || '0', 10);
      return Date.now() / 1000 > expiresAt - 60; // 60초 여유
    }

    async function refreshTokens() {
      var rt = getRefreshToken();
      if (!rt) return false;

      try {
        var res = await fetch('/auth/refresh', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ refresh_token: rt })
        });

        if (!res.ok) return false;

        var data = await res.json();
        var expiresAt = Math.floor(Date.now() / 1000) + data.expires_in;
        sessionStorage.setItem('id_token', data.id_token);
        sessionStorage.setItem('access_token', data.access_token);
        sessionStorage.setItem('expires_at', String(expiresAt));
        return true;
      } catch (e) {
        return false;
      }
    }

    async function authFetch(url, options) {
      if (isTokenExpired()) {
        var refreshed = await refreshTokens();
        if (!refreshed) {
          clearTokens();
          window.location.href = '/';
          return null;
        }
      }

      var token = getToken();
      if (!token) {
        window.location.href = '/';
        return null;
      }

      options = options || {};
      options.headers = options.headers || {};
      options.headers['Authorization'] = 'Bearer ' + token;

      var res = await fetch(url, options);

      // 401이면 토큰 갱신 시도 후 재시도
      if (res.status === 401) {
        var refreshed2 = await refreshTokens();
        if (!refreshed2) {
          clearTokens();
          window.location.href = '/';
          return null;
        }
        options.headers['Authorization'] = 'Bearer ' + getToken();
        res = await fetch(url, options);
      }

      return res;
    }

    // ── Alert Helpers ─────────────────────────────────────
    function showAlert(type, message) {
      var area = document.getElementById('alertArea');
      var cls = type === 'success' ? 'alert-success' : 'alert-error';
      area.innerHTML = '<div class="alert ' + cls + '">' + message + '</div>';
      setTimeout(function() { area.innerHTML = ''; }, 5000);
    }

    // ── Kakao Connect ─────────────────────────────────────
    async function connectKakao() {
      var btn = document.getElementById('kakaoConnectBtn');
      btn.disabled = true;
      btn.textContent = '연동 중...';

      try {
        var res = await authFetch('/auth/kakao/start-url?return_to=/dashboard.html');
        if (!res || !res.ok) {
          showAlert('error', '카카오 연동 URL을 가져오지 못했습니다.');
          btn.disabled = false;
          btn.textContent = '카카오 연동하기';
          return;
        }
        var data = await res.json();
        window.location.href = data.authorize_url;
      } catch (e) {
        showAlert('error', '카카오 연동 중 오류: ' + e.message);
        btn.disabled = false;
        btn.textContent = '카카오 연동하기';
      }
    }

    // ── Copy Helpers ────────────────────────────────────────
    function copyBlock(elementId) {
      var text = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(text).then(function() {
        showAlert('success', '클립보드에 복사되었습니다.');
      });
    }

    function copyMcpConfig() {
      var text = document.getElementById('mcpConfigText').textContent;
      navigator.clipboard.writeText(text).then(function() {
        showAlert('success', 'MCP 설정이 클립보드에 복사되었습니다.');
      });
    }

    // ── Render MCP Config ─────────────────────────────────
    function renderMcpConfig(userId) {
      var config = {
        "mcpServers": {
          "kakao-local-bridge": {
            "command": "node",
            "args": ["dist/index.js"],
            "cwd": "<path-to>/claude-code-kakaotalk/local-bridge",
            "env": {
              "TARGET_USER_ID": userId
            }
          }
        }
      };
      var configStr = JSON.stringify(config, null, 2);
      var block = document.getElementById('mcpConfigBlock');
      var btn = block.querySelector('.copy-btn');
      block.innerHTML = '';
      if (btn) block.appendChild(btn);
      var code = document.createElement('span');
      code.id = 'mcpConfigText';
      code.textContent = configStr;
      block.appendChild(code);
    }

    // ── Render Kakao Status ───────────────────────────────
    function renderKakaoStatus(kakao) {
      var container = document.getElementById('kakaoStatus');
      var btn = document.getElementById('kakaoConnectBtn');

      if (kakao.connected) {
        container.innerHTML =
          '<span class="status-badge status-connected">연동 완료</span>' +
          '<div style="margin-top:0.8rem;">' +
          '<div class="info-row"><span class="info-label">Kakao User Key</span><span class="info-value">' +
          (kakao.kakao_user_key || 'N/A') + '</span></div>' +
          '<div class="info-row"><span class="info-label">Scope</span><span class="info-value">' +
          (kakao.scope || 'N/A') + '</span></div>' +
          '</div>';
        btn.textContent = '다시 연동하기';
        btn.className = 'btn-action btn-secondary';
      } else {
        container.innerHTML = '<span class="status-badge status-disconnected">미연동</span>' +
          '<p style="margin-top:0.5rem;font-size:0.85rem;color:#666;">카카오톡으로 알림을 받으려면 연동이 필요합니다.</p>';
        btn.textContent = '카카오 연동하기';
      }
    }

    // ── Init ──────────────────────────────────────────────
    (async function init() {
      // 로그인 체크
      var token = getToken();
      if (!token) {
        window.location.href = '/';
        return;
      }

      // URL에서 kakao_connected 파라미터 확인
      var params = new URLSearchParams(window.location.search);
      if (params.get('kakao_connected') === 'true') {
        showAlert('success', '카카오 연동이 완료되었습니다!');
        // URL에서 파라미터 제거
        window.history.replaceState({}, '', '/dashboard.html');
      }

      // 로그아웃 버튼: sessionStorage도 클리어
      document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        clearTokens();
        window.location.href = '/auth/logout';
      });

      // /auth/me 호출
      try {
        var res = await authFetch('/auth/me');
        if (!res || !res.ok) {
          clearTokens();
          window.location.href = '/';
          return;
        }

        var data = await res.json();

        // Loading 숨기기
        document.getElementById('loadingArea').style.display = 'none';

        // User Info
        document.getElementById('userId').textContent = data.user_id;
        document.getElementById('authMethod').textContent = data.auth_method;
        document.getElementById('headerUser').textContent = data.user_id.substring(0, 8) + '...';
        document.getElementById('userCard').style.display = 'block';

        // Kakao Status
        renderKakaoStatus(data.kakao);
        document.getElementById('kakaoCard').style.display = 'block';

        // MCP Config
        renderMcpConfig(data.user_id);
        document.getElementById('bridgeCard').style.display = 'block';

      } catch (e) {
        document.getElementById('loadingArea').innerHTML =
          '<p style="color:#c62828;">사용자 정보를 불러오지 못했습니다: ' + e.message + '</p>' +
          '<p style="margin-top:0.5rem;"><a href="/">홈으로 돌아가기</a></p>';
      }
    })();
  </script>
</body>
</html>
